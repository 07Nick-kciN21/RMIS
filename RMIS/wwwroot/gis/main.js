// ============================================================================
// main.js - 主程式入口模板
// 負責應用程式核心初始化和模組載入協調
// ============================================================================

// ============================================================================
// 模組匯入區塊
// ============================================================================

// 初始化模組
//import { initEnvironment } from "./init/initEnvironment.js";
import { initLeafletMap } from "./init/initLeafletMap.js";
import { initEnvironment } from "./init/initEnvironment.js";
// 功能載入器
import { loadBase } from "./widgets/loadBase.js";

// 事件處理器模組
// import { graphicHandler } from "./widgets/tool/graphicHandler.js";
// import { coordinateHandler } from "./widgets/tool/coordinateHandler.js";
// import { datetimeHandler } from "./../../common/datetimeHandler.js";
// import { utility } from "./widgets/tool/utility.js";

// ============================================================================
// 全域變數宣告
// ============================================================================

// 使用者認證相關變數
// 可以從 DOM 元素取得，或透過 API 取得
var apiToken;       // API 存取令牌
var userId;         // 使用者 ID  
var userDepName;    // 使用者部門名稱
var userDepId;      // 使用者部門 ID
var userRole;       // 使用者角色

// 從 DOM 元素取得使用者資訊的範例（註解掉）
// var apiToken = document.getElementById("HiddenAPIToken").value;
// var userId = document.getElementById("HiddenUserId").value;
// var userDepName = document.getElementById("HiddenDEPName").value;
// var userDepId = document.getElementById("HiddenDEPId").value;
// var userRole = document.getElementById("HiddenRole").value;

// AJAX 全域設定（如果使用 jQuery）
// $(document).ajaxSend(function (event, jqXHR, ajaxOptions) {
//     jqXHR.setRequestHeader("token", apiToken);
// });

// Fetch API 包裝函數範例
// var postData = function(url, data) {
//     return fetch(url, {
//         body: JSON.stringify(data), 
//         cache: 'no-cache',
//         headers: {
//             'token': apiToken
//         },
//         method: 'POST', 
//     }).then(response => response.json())
// }

// ============================================================================
// 應用程式核心物件
// ============================================================================
var appCore = {};

// ============================================================================
// 應用程式啟動函數
// ============================================================================

/**
 * 應用程式啟動主函數
 * 當所有必要模組（地圖 + UI）載入完成後執行
 */
appGlobal.start = function () {
    console.log("應用程式開始初始化...");
    
    // 初始化應用程式核心物件
    initappGlobal();
    initLeafletMap.initMap(appCore);
    // ========================================================================
    // 工具和處理器初始化
    // ========================================================================
    
    // 工具處理器初始化
    // utility.init(appCore);
    // appCore.handler.utility = utility;

    // ========================================================================
    // 地圖和場景初始化
    // ========================================================================
    
    // 2D 地圖初始化
    // initMap.initMap(appCore);
    
    // 3D 場景初始化
    // initMap3D.initMap(appCore);
    // initMap3D.setMapFromGUID(appCore);

    // ========================================================================
    // 符號和樣式初始化
    // ========================================================================
    
    // initSymbol.init(appCore);

    // ========================================================================
    // 功能模組載入
    // ========================================================================
    
    // 載入基礎功能模組
    loadBase.init(appCore);

    // ========================================================================
    // 使用者資訊初始化
    // ========================================================================
    
    // initUserInfo.init(appCore);

    // ========================================================================
    // 事件處理器初始化
    // ========================================================================


    console.log("應用程式初始化完成");

    /**
     * 初始化應用程式全域物件
     * 設定 appCore 的基本結構和預設值
     */
    function initappGlobal() {
        console.log("初始化 AppCore 核心物件...");

        // ====================================================================
        // 使用者相關資訊
        // ====================================================================
        appCore.userId = userId;        

        // ====================================================================
        // 環境設定
        // ====================================================================
        appCore.environment = initEnvironment;

        // ====================================================================
        // 地圖相關物件初始化
        // ====================================================================
        
        // 地圖物件容器
        appCore.map = {};
        appCore.layers = {};
        
        // 地圖基本圖層
        appCore.layers.baseLayers = {};
        appCore.layers.overlayMaps = {};

        // ====================================================================
        // 視圖相關物件初始化
        // ====================================================================
        
        appCore.view = {};
        
        // 主要 3D 場景視圖
        appCore.view.sceneView = null;
        appCore.view.containerName = "indexMap";
        
        
        // 其他視圖屬性
        // appCore.view.activeView = null;     // 當前啟用的視圖
        // appCore.view.mapView = null;        // 2D 地圖視圖

        // ====================================================================
        // 圖層管理物件初始化
        // ====================================================================
        
        appCore.mapImageLayer = {};

        // ====================================================================
        // 圖形物件管理初始化
        // ====================================================================
        
        appCore.graphics = {};
        appCore.graphics.general = {};  // 一般用途圖形
        appCore.graphics.func = {};     // 功能專用圖形

        // ====================================================================
        // 符號系統初始化
        // ====================================================================
        
        appCore.symbols = {};

        // ====================================================================
        // 應用程式狀態管理初始化
        // ====================================================================
        
        appCore.status = {};
        appCore.status.identify = false;        // 識別查詢狀態
        appCore.status.spaceQuery = false;      // 空間查詢狀態
        appCore.status.mapClick = "";           // 地圖點擊模式

        // ====================================================================
        // 功能模組容器初始化
        // ====================================================================
        
        appCore.func = {};

        // ====================================================================
        // UI 容器系統初始化
        // ====================================================================
        
        appCore.bag = {};

        // ====================================================================
        // 事件處理器容器初始化
        // ====================================================================
        
        appCore.handler = {};

        // ====================================================================
        // 資訊存儲容器初始化
        // ====================================================================
        
        appCore.info = {};

        // ====================================================================
        // 設備相關設定
        // ====================================================================
        
        if (appGlobal.mapDevice === "mobile") {
            appCore.mapDevice = "mobile";
            appCore.status.spaceQuery = false;
            $("#tutorial").hide();  // 隱藏教學提示
        } else {
            appCore.mapDevice = "desktop";
            appCore.status.spaceQuery = true;
        }

        // ====================================================================
        // 使用者資訊設定（如果已載入）
        // ====================================================================
        
        // appCore.info.userId = userId;
        // appCore.info.userRole = userRole;
        // appCore.info.userDepName = userDepName;
        // appCore.info.userDepId = userDepId;

        // ====================================================================
        // 環境設定
        // ====================================================================
        
        // appCore.environment = initEnvironment;

        // ====================================================================
        // 將 appCore 掛載到全域物件
        // ====================================================================
        
        appGlobal.appCore = appCore;
        
        console.log("AppCore 核心物件初始化完成");
    }
};

// ============================================================================
// 模組載入狀態檢查
// ============================================================================

/**
 * 檢查所有必要模組是否已載入完成
 * 如果都完成了，就啟動應用程式
 */
appGlobal.start();